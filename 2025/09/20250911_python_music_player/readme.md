# 課題: PyQt を用いた GUI ミュージックプレイヤー

## 目的
- GUI 操作で音楽を再生・一時停止・停止・前/次曲移動できるプレイヤーを作成する。
- **再生位置スライダー（シーク）**と**音量スライダー**の UI 連携を実装する。
- ディレクトリとメタデータ（JSON）を**照合**してプレイリストを構築する。

## 環境
- OS: Windows 11
- エディタ: VSCode
- 言語/GUI: Python + PyQt（PyQt6 または PyQt5 のいずれか）
- 実行: `python src/main.py`

## ディレクトリ構成（固定）
```
project_root/
├─ music/
│  ├─ track1/
│  │  ├─ sample1.mp3
│  │  └─ sample2.mp3
│  ├─ track2/
│  │  ├─ sample3.mp3
│  │  └─ sample4.mp3
│  └─ metadatas.json
└─ src/
   ├─ main.py                  # ルートエントリ: MainWindow を起動
   ├─ database.py              # メタ情報と実ファイルの照合ロジック
   ├─ main_window/
   │  ├─ __init__.py
   │  └─ mainwindow.py         # ユーザー操作（UI層）
   └─ player/
      ├─ __init__.py
      └─ service.py            # 再生サービス層（QMediaPlayer をラップ）
```

> **構成に関する注記**  
> - `src/player` は**再生サービス層**として実装すること。  
> - **QMediaPlayer を別スレッドへ移動しないこと**（Qtの仕様上、GUI スレッドに常駐させるのが安全）。  
> - スレッド化が必要な処理（例: 重いスキャン/解析）は **QThread で別スレッド化**し、UI へは signal/slot で更新する方針とする。

## 入力（データ仕様）
- 音源ファイル: `music/track1/` および `music/track2/` 配下の音声ファイル（mp3/wav/m4a/flac のいずれか）。  
- メタデータ: `music/metadatas.json`（以下スキーマ）

```json
{
  "tracks": [
    { "path": "track1/sample1.mp3", "title": "Blue Morning",  "artist": "Alice", "album": "Early Birds" },
    { "path": "track1/sample2.mp3", "title": "City Lights",   "artist": "Bob",   "album": "Night Drive" },
    { "path": "track2/sample3.mp3", "title": "Soft Rain",     "artist": "Caro",  "album": "Quiet Days" },
    { "path": "track2/sample4.mp3", "title": "Orbit",         "artist": "Dana",  "album": "Zero-G" }
  ]
}
```

- `path` は **`music/` からの相対パス**。  
- JSON に記載がない実ファイルが存在する場合は、**ファイル名（拡張子除く）をタイトルとして補完**してもよい。

## 出力（UI/挙動）
- プレイリスト表示（表形式推奨）  
  列例: `Group`（track1/track2）, `Title`, `Artist`, `File`（相対パス）。
- 再生中の曲情報表示: `Title`, `Artist`, `Album`。
- **再生位置表示**: 左に現在位置 `mm:ss`、右に総時間 `mm:ss`。中央にスライダー。
- **音量スライダー**: 0〜100%。現在値の数値表示を併記。
- 基本操作ボタン: `Prev`, `Play`, `Pause`, `Stop`, `Next`。

## 機能要件
1. **再生/一時停止/停止/前/次曲** が動作すること。  
2. **再生位置スライダーで任意位置へシーク**できること。  
   - スライダーをドラッグ中は UI 側の時刻表示が追従し、リリース時にプレイヤーへ反映。  
3. **音量スライダーで音量調整**できること。  
   - PyQt6: 内部は 0.0〜1.0、UI は 0〜100% にマッピング。  
   - PyQt5: 内部・UI ともに 0〜100。  
4. **曲末到達時に自動で次曲**へ移ること（ループは不要）。  
5. `metadatas.json` とディレクトリ走査結果を**照合**し、プレイリストを生成すること。  
6. ディレクトリ内の音源/JSON は**追加・削除に耐性**があること（JSON だけにある/ファイルだけあるケースの扱いを定義）。

## 非機能要件
- 再生位置の UI 更新は **200〜300ms 周期**でよい（タイマー更新など）。  
- 例外や未対応コーデックなどで再生できない場合は、**ユーザーへわかる形で通知**すること（ダイアログ/ステータスバー/ラベル等）。  
- 長時間再生しても UI が固まらないこと（重い処理は別スレッド化）。

## モジュール責務
- `src/main.py`  
  - アプリケーションのエントリポイント。`MainWindow` を生成して表示。
- `src/database.py`  
  - `music/` 配下を走査し、`metadatas.json` と照合して **Track** リストを返す。  
  - **Track** データ型（id, 絶対パス, 相対パス, title, artist, album, group）を定義。
- `src/main_window/mainwindow.py`  
  - プレイリストの表示・選択、ボタン操作、スライダー操作、音量操作など **UI とユーザー操作**一式。  
  - 再生位置/総時間の表示更新、曲末での自動 Next。
- `src/player/service.py`  
  - **QMediaPlayer をラップ**した再生サービス。`load(file)`, `play()`, `pause()`, `stop()`, `set_position(ms)`, `set_volume(%)`, `duration()`, `position()` などを提供。  
  - **注意**: QMediaPlayer は GUI スレッドに置くこと。必要に応じてファイル走査や解析を **QThread** 側に分離。

## UI 要件（動作の定義）
- プレイリストの行 **ダブルクリック**でその曲をロードして再生。  
- `Prev` は先頭から呼ぶと末尾へ、`Next` は末尾で呼ぶと先頭へ（循環でよい）。  
- 音量スライダー操作時、現在値（%）の表示が即時更新される。  
- シーク中（ドラッグ中）は自動位置更新を一時停止し、**ドロップ時にジャンプ**する。

## コーデック等の注意
- OS のコーデック依存。Windows では MP3/WAV は概ね再生可能。  
- 再生不可形式やコーデック不足時はエラーメッセージを表示すること。

## 受け入れテスト（手順）
1. アプリ起動後、プレイリストに 4 曲が表示される。  
2. 曲をダブルクリック → 再生開始、タイトル/アーティスト/アルバムが表示される。  
3. 音量 0% → 無音、50% → 音量が半減、100% → 最大。  
4. 再生位置スライダーを 30 秒付近までドラッグしてリリース → 直ちに 30 秒付近へジャンプ。  
5. 曲の終了時、自動で次曲が再生される。  
6. `Prev`/`Next` ボタンで循環移動できる。  
7. `metadatas.json` の 1 曲を削除して再起動 → ファイル名ベースでタイトル補完されるか、スキップされる（仕様どちらでも可だが挙動を明記）。  

## 提出物
- 上記ディレクトリ構成のソース一式。  
- `README.md`（起動方法、対応 PyQt バージョン、既知の制限、JSON と実ファイル不一致時の挙動を明記）。  

## 発展課題（任意）
- シャッフル/リピートモード。  
- 再生中行のハイライト。  
- 波形やスペクトラムの簡易表示（重い計算は QThread で）。  
- キーボードショートカット（Space: 再生/一時停止、←/→: シーク、↑/↓: 音量）。  

---  

**チェックポイント**  
- QMediaPlayer を GUI スレッドで扱う設計にすること。  
- スレッドを使う場合は、**重い処理のみ**を QThread に分離し、UI 更新は signal/slot に限定すること。
