# 今日のPython課題：Streaming “重み付き” Top-K（遅延更新あり）

## ストーリー
ログがストリーミングで流れてきます。各イベント名には「スコア（重み）」があり、`ADD` / `DECAY` / `TOPK` を順に処理して、要求されたタイミングで **スコア上位K件** を出してください。  
ポイントは、`DECAY` が「全イベントのスコアを一律に減らす（ただし0未満にはしない）」という **遅延更新（lazy）** を要求してくることです。

---

## 入力
1行目：
- `Q K`（クエリ数 Q、上位件数 K）

2行目以降：Q行のクエリ。形式は次のいずれか。

- `ADD name x`  
  イベント `name` のスコアに `x` を加算する（`x` は正の整数）

- `DECAY d`  
  **全イベントのスコアを `d` 減らす**（0未満にはしない）

- `TOPK`  
  現時点のスコア上位K件を出力する

---

## 出力
`TOPK` クエリごとに K行出力（ただしスコアが0のものは出力対象外）。  
並び順は：

1. スコア降順
2. スコアが同じなら `name` の辞書順昇順

出力形式：
- `name score`

もし出力対象（スコア>0）が1件もない場合は、`EMPTY` を1行だけ出力。

---

## 制約
- `1 <= Q <= 2*10^5`
- `1 <= K <= 50`
- `name` は英小文字（例：`login`, `buy`, `view`）長さ1〜20
- `ADD x`, `DECAY d` は `1 <= x,d <= 10^9`
- `TOPK` は最大で `2*10^5` 回出る可能性あり

**素直に `DECAY` のたびに全要素を更新すると死にます。**

---

## 例
入力：
```
10 3
ADD a 10
ADD b 7
TOPK
DECAY 5
TOPK
ADD b 10
ADD c 6
TOPK
DECAY 20
TOPK
```

出力：
```
a 10
b 7
a 5
b 2
b 12
a 5
c 6
EMPTY
```

---

## 要求仕様（これが本題）
`DECAY d` を **全要素更新せず** に処理してください。  
ヒント：`global_offset` 的な発想（全体の減衰をまとめて持つ）と、0クリップ（0未満を0扱い）を矛盾なく扱う必要があります。

---

## 実装要件
- Python 3.11想定
- 標準入力から読み、標準出力へ
- 計算量の目安：だいたい `O(Q log N)` かそれに近い感じ（Nは登場したname数）

---

## 解説（関連モジュール/考え方）
### 1) 遅延更新（Lazy）
`DECAY d` は「全スコア -d」という操作ですが、毎回全要素に触ると `O(NQ)` になります。  
そこで「全体に適用される減算分」を `G` として持ち、各イベントは **“生の値”** を保存しておきます。

例：
- 実スコア = `max(0, raw[name] - G)`

`ADD name x` は実スコアに x を足したいので、
- 実スコア = `max(0, raw - G)`
- これに x を足す → 新しい実スコア = `old + x`
- つまり raw を `raw += x` すればOK（Gは同じ）

ただし `raw - G` が負のとき実スコアは0なので、「0から加算した」ように振る舞う必要があります。

### 2) TOPKを速くする
毎回全nameをソートしてたら終わります。  
Top-Kを取り続ける典型は、
- ヒープ（priority queue）
- “古い候補” をヒープに残しつつ、取り出すときに検証して捨てる（lazy deletion）

Python標準の `heapq` は **最小ヒープ** なので、`(-score, name)` を積むのが基本。

ただし今回のscoreは `max(0, raw - G)` で変動するので、
- ヒープに入れる「その時点の見かけスコア」と
- 実際に取り出したときの「今のスコア」
がズレます。ズレたら捨てて最新を積み直す、の戦術が効きます。

---

## 仕上げのチェック項目
- `DECAY` を何回しても壊れない（Gが巨大になってもOK）
- スコア0は出力しない
- 同点は辞書順
- TOPKでK件未満しか正のスコアが無い場合、その分だけ出す（0件ならEMPTY）
- 入力が大きいので `sys.stdin.buffer.readline` 推奨

---

この課題、実装すると「遅延評価 + ヒープの怠惰削除」の合わせ技が身につきます。  
地味にログ集計・ランキング・レコメンド前処理のミニチュアで、現場感あります。
