# 🧪 OneDayOneCode：PyQt6 × OpenCV × MediaPipe で「寝落ち検出」GUI

## 概要

Webカメラ映像を取得し、**30秒ごと**に MediaPipe を用いた簡易アルゴリズムでユーザーの寝落ち（居眠り）を判定します。検出時はGUI上に検出時刻とメッセージをリスト表示します。  
`--view` オプションを付けると、検出に使ったフレーム画像やMediaPipeのデバッグ情報も表示します。

---

## 実行環境

- **OS:** Windows 11
- **IDE:** VSCode
- **言語:** Python 3.10+
- **主要ライブラリ:**
    - PyQt6
    - OpenCV (`opencv-python`)
    - MediaPipe

---

## 事前準備（インストール）

```sh
pip install pyqt6 opencv-python mediapipe
```

---

## 要求仕様

### 1. 基本機能

- Webカメラから映像を取得し、バックグラウンドで監視を継続
- 30秒ごと（デフォルト）に「寝落ち検出」を実行
- 寝落ち検出時、GUI画面のリストにタイムスタンプと説明文を追記  
    例: `2025-09-03 15:42:10：寝落ちを検出`
- アプリ終了時はカメラリソース等を確実に解放

### 2. GUI要件（PyQt6）

- **最低限の構成:**
    - ステータス表示領域（実行状態や最後のチェック時刻など）
    - 検出ログリスト（時系列で表示）
- （任意）開始／停止ボタン、終了ボタン、アイコンやステータスバー
- UIはフリーズしないこと（QThreadやQTimerでメインスレッドを塞がない）

### 3. 寝落ち判定（MediaPipeを用いた最小要件）

- MediaPipe Face Mesh等で顔特徴点を取得し、任意の妥当なルールで寝落ちを定義
- **例（いずれかでOK）:**
    - 目の開閉度（EAR: Eye Aspect Ratio）が閾値未満の状態が連続2秒以上
    - 顔の下向きピッチ角が一定以上＋目の開閉度が低い状態が持続
    - 30秒間の行動指標で「瞬目が極端に少ない」など
- **採用ルール・パラメータはREADMEに明記**

### 4. 30秒周期チェック

- デフォルトのチェック間隔は30秒（QTimer等で周期トリガー）
- チェック時は**直近2〜5秒程度**のフレームで「連続的に閉眼しているか」等を評価

### 5. `--view` オプション（デバッグビュー）

- `--view` 付き起動時のみ下記を表示:
    - 検出に使用したフレーム画像（OpenCVウィンドウ等）
    - 画像上にMediaPipeランドマーク、EAR値、判定数値、ヘッドポーズ角度などのデバッグオーバーレイ
- `--view` なし時はウィンドウ非表示でGUIログのみ更新

---

## 入出力仕様

### コマンドライン引数（入力）

- `--view` : デバッグ表示を有効化（任意）
- `--device <int>` : 使用カメラデバイス番号（任意、デフォルト0）
- `--interval <int>` : 判定間隔（秒、デフォルト30）
- `--csv <path>` : 検出ログをCSV保存する場合の出力先（任意）

#### 起動例

```sh
# 通常起動（GUIのみ／30秒周期）
python main.py

# デバッグ表示あり、デバイス1、判定間隔60秒
python main.py --view --device 1 --interval 60
```

### GUI出力（必須）

- 検出ログリストに以下形式で追記  
    `YYYY-MM-DD HH:MM:SS：寝落ちを検出`
- （オプション）`EAR=0.18 / 連続2.3s / pitch=22°` などの補足

### ファイル出力（任意）

- `--csv` 指定時、CSV形式で検出ログを追記保存  
    列例: `timestamp,event,ear_mean,ear_min,closed_seconds,pitch_deg` など

---

## エラーハンドリング

- カメラ取得失敗時はGUIにエラーメッセージ表示し終了またはリトライ
- MediaPipe初期化失敗時は代替メッセージを出して安全に終了
- スレッド終了時の例外は握りつぶさず、ユーザーに通知

---

## 実装ヒント（任意）

- **スレッド／タイマー構成:**
    - フレーム取得: QThreadまたはQTimerで定期取得 → pyqtSignalでGUIに渡す
    - 判定トリガ: QTimer(interval=30*1000)で周期発火 → 直近フレーム群を評価
- **EAR（Eye Aspect Ratio）:**
    - 目の上下・左右距離から計算される簡易閉眼指標
    - MediaPipeの目周りランドマークで実装可能
    - 閾値例: 0.2前後（個人差あり・調整必須）
- **ヘッドポーズ（任意）:**
    - 鼻先や目、耳など既知3D座標と2DランドマークからsolvePnPで姿勢推定し、ピッチ角で下向き度を評価

---

## 完成条件（受け入れ基準）

- アプリ起動で30秒ごとに寝落ち判定が実行される
- 寝落ち検出時、GUIログリストに時刻＋メッセージが追記される
- `--view` ありで起動するとフレーム画像とMediaPipeデバッグ情報が視覚的に確認できる
- カメラ解放・スレッド停止が正常に完了（終了時に例外・ハングなし）
- READMEに採用判定ルール・主要パラメータが明記されている

---

## 提出物

- `main.py`（エントリポイント）
- `sleep_detector.py`（判定ロジックをクラス化等）
- `ui/`（必要なら）
- `README.md`（判定ルール・実行方法・依存関係）
- （任意）`logs/sleep_log.csv` サンプル
