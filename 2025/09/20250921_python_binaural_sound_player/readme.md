# 🎧 OneDayOneCode: Pygameでバイノーラル風ボイス再生システム

## 概要
Pygame を用いて、**単一音源のボイスをリスナー（＝自分）の周りで回転・前後移動させられる**ミニプレイヤーを実装してください。  
左右キーで**方位（水平角）**を回転、上下キーで**距離**を前後させ、**バイノーラル風（擬似3D）**に聴こえるよう、**左右チャネルの音量差（ILD）**と**微小遅延（ITD）**、および**距離に応じた減衰**（必要なら簡易LPF）を適用して再生します。

> ※ここでいう「バイノーラル風」は**厳密なHRTF**ではなく、Pygameのみで実装できる**近似**（ILD + ITD + 距離減衰 + 簡易フィルタ）を意味します。

---

## 仕様

### 実行
```bash
python main.py --file <音声ファイルへのパス> [--rate 44100] [--chunk 1024]
```
- `--file` : 入力ボイス（**推奨: モノラル 44.1kHz WAV**。Ogg可。MP3は環境依存）
- `--rate` : サンプリングレート（既定 44100）
- `--chunk`: 最小処理サンプル数（既定 1024）

### 操作
- ← / → : 方位角 `azimuth` を -180°〜+180°で回転（右回り/左回りはどちらでも可）
- ↑ / ↓ : 距離 `r` を増減（例: 0.2m〜3.0mでクリップ）
- `R`     : 初期位置にリセット（例: azimuth=0°, r=1.0m）
- `ESC` or `Q` : 終了

画面には以下を**HUD表示**：
- 現在角度（deg）、距離（m）
- ILD係数・ITDサンプル数（デバッグ値）
- 再生状態（Playing/Stopped）

---

## 音場モデル（最低限）

1. **距離減衰（Radial Attenuation）**  
   振幅ゲイン  
   \\[ g(r) = \\frac{1}{1 + k r^2} \\quad (k=0.5 など) \\]  
   を用いる。最終ゲインは 0.15〜1.0 にクリップ。

2. **左右音量差（ILD: Interaural Level Difference）**  
   方位角 \\(\\theta\\)（ラジアン）に対し、  
   \\[
   p = \\sin(\\theta),\\quad
   L = g(r)\\cdot \\sqrt{\\frac{1-p}{2}},\\quad
   R = g(r)\\cdot \\sqrt{\\frac{1+p}{2}}
   \\]  
   として左右ゲインを決める（等電力パンの考えに近い）。

3. **微小遅延（ITD: Interaural Time Difference）**  
   頭部幅 \\(d=0.18\\) m、音速 \\(c=343\\) m/s とし、  
   \\[
   \\Delta t(\\theta) = \\frac{d}{c}\\sin(\\theta) \\quad (\\text{最大}\\ \\approx 0.52\\ \\text{ms})
   \\]  
   サンプル遅延 \\(N = \\mathrm{round}(\\Delta t \\cdot \\text{sample\\_rate})\\)。  
   \\(\\sin\\theta > 0\\) なら **右耳を遅らせる**（左から到来）、逆も同様。実装は**片側にNサンプルのゼロ埋め**。

4. **（任意）距離に応じた簡易LPF**  
   距離が遠いほど高域が減るよう、移動平均や一次IIRで**軽いローパス**を適用（CPU負荷と相談）。

---

## 実装指針

- **方針**：原音（モノラル）を `numpy` 配列として読み込み、**小さなチャンク単位**で
  1) ILDゲイン適用 → 2ch化、2) ITD用に片耳へサンプル遅延、3) 必要なら距離LPF、を行い、
  `pygame.sndarray.make_sound(stereo_chunk)` を `Channel.queue()` する方式。

- `pygame.mixer.Sound`/`Channel.set_volume` だけでは左右独立ゲインやITDを柔軟に扱いづらいため、**自前でステレオ波形を合成**する。  
- 逐次 `queue()` で**XRUNしない**よう、**2〜3チャンク先行**でキューする簡易バッファリングを実装。

> 依存：**標準ライブラリ + pygame + numpy** を想定。Windows + VSCode 環境。

---

## 入出力

### 入力
- **コマンドライン引数**のみ：
  - `--file`（必須）: `example.wav`（**推奨: 16-bit PCM, 44.1kHz, mono**）
  - `--rate`（任意）: 例 44100
  - `--chunk`（任意）: 例 1024, 2048

### 出力
- PygameウィンドウにテキストHUD表示  
- 標準出力にデバッグログ（任意）

---

## 要件チェックリスト
- [ ] `--file` の音声を**モノラルとして解釈**し、**ステレオ合成**して再生できる  
- [ ] 矢印キーで角度・距離を**リアルタイム変更**し、**定位が変化**する  
- [ ] **ILD + ITD + 距離減衰**が同時適用される  
- [ ] HUDで角度・距離・ITDサンプル数等が**常時表示**される  
- [ ] バッファ枯渇による音切れが目立たない（チャンク/キュー調整）  
- [ ] ESC/Q で安全に終了（MixerとPygameの終了処理）

---

## 最小ディレクトリ例
```
project/
  main.py
  spatializer.py
  audio_engine.py
  assets/
    voice_sample_mono.wav
```

---

## 評価観点
- バッファリングやチャンク設計が適切で**音切れが少ない**
- 角度・距離の変化が**聴感に一貫性**をもって反映される
- コードの**モジュール分割**と可読性（`audio_engine.py` / `spatializer.py` / `main.py`）
- Windows 11 + VSCodeでの**再現性**

---

## 追加課題（任意）
- 壁・反射の簡易モデル（遅延+減衰コピーで簡易リバーブ）
- 角度・距離の自動アニメーション（キー未入力時に周回）
- LPFの改良（距離依存でカットオフを連続可変）
- **マルチ音源**対応（音源ごとに合成→加算→クリップ回避）

---

## 提出物
- すべてのソースコード
- `README.md`（実行方法、対応フォーマット、検証手順）
- 動作キャプチャ（任意：スクショや短い動画）

---

## メモ
- **厳密なHRTF**（頭部伝達関数）を用いるには外部HRTFデータ+FFT畳み込みが必要。本課題は**Pygame標準の範囲**での**リアルタイム近似**に留める。将来的に本格化させる場合は**SOFA**形式のHRTF導入を検討。  
- まずは **ILD + ITD + 距離減衰** を正しく入れることに集中すること。
