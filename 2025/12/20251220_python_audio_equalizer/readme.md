# Python課題: CLIグラフィックEQ（オフライン処理）

**目的**  
UIを使わず、CLIのみで操作する**10バンド・グラフィックイコライザー**を実装し、指定のWAVファイルに対してEQ処理を行い、出力WAVを生成せよ。  
リアルタイム再生は不要（拡張課題とする）。本課題は**キー操作でゲインを設定 → Enterで一括処理**のオフライン方式。

---

## 機能要件

### 1) バンド構成
- 中心周波数（Hz）:  
    `31, 62, 125, 250, 500, 1000, 2000, 4000, 8000, 16000`
- 各バンドは**ピーキングEQ**（IIR/Biquad）で実装すること  
    - 推奨: **RBJ Cookbook** の peaking EQ 係数（ヒント参照）
- ゲイン範囲: **±12 dB**（整数ステップ 1 dB）
- Q値（帯域幅）は**固定**（例: **Q = 1.4**）

### 2) 入出力
- 入力: **WAV (PCM 16-bit, mono/stereo)**, サンプリングレート **44100** または **48000** のみ対応  
    - stereoの場合は**左右同一設定**で処理
- 出力: **WAV (PCM 16-bit)**  
- クリッピング対策: いずれかを**必須**で実装  
    - (A) 全体ヘッドルーム確保（例: マスタゲイン -6 dB）  
    - (B) ソフトクリップ（例: `tanh` による緩やかな飽和）

### 3) CLI表示・操作

```
31 |■■■■■■■■|
62 |■■■■■■　　|
125 |■■■■　　　　|<
250 |■■■　　　　　|
500 |■■■　　　　　|
1K |■■■■■■　　|
2K |■■■■■　　　|
4K |■■■　　　　　|
8K |■■■■■■　　|
16K |■■■　　　　　|
```

- `"<"` は**選択中のバンド**（カーソル）を示す
- **矢印キー 上/下**: カーソル移動  
- **矢印キー 左/右**: 現在選択中バンドのゲインを ±1 dB で調整  
- **R**: すべてのゲインを 0 dB にリセット  
- **S**: 現在の設定を JSON 保存（例: `eq.json`）  
- **L**: JSON を読込んで設定を復元  
- **Enter**: 現在設定で EQ を**適用して出力WAV生成**  
- **Q**: 終了（処理を実行せずに終了）

**表示の仕様**  
- 目盛りは、`-12 … 0 … +12 dB` を **0〜10 個の「■」**で表現する簡易バーで可  
    - 例: `blocks = round((gain_db + 12) / 24 * 10)`  
    - バーの右側は全角スペースや半角スペースで**揃えて**可読性を確保  
- 選択中行の末尾に `"<"` を付与

### 4) コマンドライン引数

```bash
python main.py --in input.wav --out output.wav [--rate 44100|48000] [--config eq.json]
```

- `--in / --out`: 入出力ファイルパス（必須）
- `--rate`: 読み込み音声のサンプリングレートが不明/可変な場合に強制リサンプリングするための指定（任意）
- `--config`: 起動時にプリセットを読み込む（任意）

---

## 実装要件

### フィルタ設計
- 各バンドを直列適用
- 倍精度浮動小数（float64）で係数計算
- 安定化のため、可能ならSOS形式（二次セクション）による適用を推奨

### 波形処理
- 内部処理は float32 または float64 に正規化し、最終的に 16-bit PCM にクリップして戻す
- ステレオはチャンネル独立処理

### パフォーマンス
- 60秒のモノラル音声を5秒以内で処理可能なこと（目安。一般的CPU想定）

### 例外処理
- 非対応フォーマット、入出力エラー、JSON不整合をユーザに分かるメッセージで通知

---

## 提出物
- `main.py`（実装本体。変更点・設計意図はコメントで明記）
- `README.md`（実行方法、依存関係、操作説明、既知の制限）
- `eq.json`（任意。保存フォーマット例）
- `requirements.txt`（必要に応じて）

---

## 動作確認
- 小さなテストWAV（10〜20秒）で起動
- バンドを大きく ±12 dB まで振って、出力WAVの聴感と波形の変化を確認

### 自己検証（任意だが望ましい）
- 簡易STFTで各バンド近傍のエネルギー変化（dB）を出力
- 入力 vs 出力のRMS・ピークの比較、クリップ率のレポート出力

---

## ヒント

### RBJ peaking EQ（biquad）の係数

**与えられた値:**  
中心周波数 f0, サンプリング周波数 Fs, ゲイン G [dB], 品質係数 Q

**補助量:**
```
A = 10^(G/40)
ω0 = 2π f0 / Fs
α = sin(ω0) / (2Q)
```

**係数（未正規化）:**
```
b0 = 1 + α*A
b1 = -2 cos(ω0)
b2 = 1 - α*A
a0 = 1 + α/A
a1 = -2 cos(ω0)
a2 = 1 - α/A
```

実装時は正規化: `b* /= a0`, `a1 /= a0`, `a2 /= a0`, `a0 = 1`

### クリッピング対策
- マスタゲインで余裕を確保（例: 出力前に -6 dB）
- または `y = tanh(k * x)`（kは適当）でソフトクリップ

